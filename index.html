<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <link rel="shortcut icon" href="webm-48px.png">
  <title>WebP image check</title>
</head>
<body class="homepage" id="None">
<div>
  <label for="selBackground">Background : </label>
  <select name="selBackground" id="selBackground"></select>
  &nbsp;&nbsp;&nbsp;
  <label for="selImage">Image : </label>
  <select name="selImage" id="selImage"></select>
  &nbsp;&nbsp;&nbsp;
  <button id="reloadImage">Reload Image</button>
  <div id = "imagePos">Position</div>
</div>

<div id="screen" style="position: relative;">
 <div id="background" style="position: absolute; left: 0; top: 0; z-index: 0;" draggable="false">
   <img id="backgroundImage" draggable="false">
 </div>
 <div id="sprite" style="position: absolute; z-index: 1;" draggable="false">
   <img id="spriteImage" draggable="false">
 </div>
</div>

<script>
// ------------ Image ------------
const background = document.getElementById('background');  
const sprite = document.getElementById('sprite');
const spritePos = document.getElementById('imagePos');

function setBackground(url) {
  console.log('Set background ' + url);
  const image = document.getElementById('backgroundImage');
  image.src = url;
  image.onload = function(){
    background.width = image.width;
    background.height = image.height;
  }
}

function setSprite(url) {
  console.log('Set sprite ' + url);
  const image = document.getElementById('spriteImage');
  image.src = url;
  image.onload = function(){
    sprite.width = image.width;
    sprite.height = image.height;
  }
}

var spriteX = 0;
var spriteY = 0;
function setSpritePos(x, y) {
  sprite.style.left = x+'px';
  sprite.style.top = y+'px';
  spriteX = x;
  spriteY = y;
  spritePos.innerHTML = 'Position X:'+x+' Y:'+y;
}

// ------------ Image Dragging ------------
var offsetX;
var offsetY;
var dragging = false;
sprite.addEventListener('pointerdown', (e) => {
  const leftButton = 0;
  const rightButton = 2;
  if (e.button == leftButton) {
    offsetX = e.offsetX;
    offsetY = e.offsetY;
    dragging = true;
    sprite.setPointerCapture(e.pointerId);
  }
});
sprite.addEventListener('pointermove', (e) => {
  if (!dragging)
    return;
  const diffX = e.offsetX - offsetX;
  const diffY = e.offsetY - offsetY;
  if (diffX != 0 || diffY != 0) {
    setSpritePos(spriteX + diffX, spriteY + diffY);
  }
});
sprite.addEventListener('pointerup', (e) => {
  dragging = false;;
});
sprite.addEventListener('lostpointercapture', (e) => {
  dragging = false;
});

// ------------ Selection ------------
const dirBackground = 'background';
const dirImage = 'image';
const selBackground = document.getElementById('selBackground');
const selImage = document.getElementById('selImage');
 const reloadImage = document.getElementById('reloadImage');

function selectImage(index) {
  if (selImage.length <= 0) return;
  if (index < 0) index = selImage.length - 1;
  if (index >= selImage.length) index = 0;
  selImage.selectedIndex = index;
  selImage.dispatchEvent(new Event("change"));
}

selBackground.addEventListener('change', () => {
  setBackground(selBackground.options[selBackground.selectedIndex].value);
});
selImage.addEventListener('change', () => {
  setSprite(selImage.options[selImage.selectedIndex].value);
  setSpritePos(spriteX, spriteY);
});
reloadImage.addEventListener("click", () => {
  const image = document.getElementById('spriteImage');
  image.src = '';
  image.src =selImage.options[selImage.selectedIndex].value;
});
window.addEventListener("keydown", (e) => {
  switch(e.key) {
  case 'ArrowUp':
    selectImage(selImage.selectedIndex - 1);
    break;
  case 'ArrowDown':
    selectImage(selImage.selectedIndex + 1);
    break;
  default:
    break;
  }
});

// ------------ Request list ------------
function addOptions(url, sel, text) {
  try {
    const array = JSON.parse(text);
    array.forEach((name) => {
        var opt = document.createElement('option');
        opt.value = url + '/' + name;
        opt.innerHTML = name;
        sel.appendChild(opt);
    });
    sel.dispatchEvent(new Event("change"));
  } catch (e) {
    console.log("Cannot parse : " + text);
  }
}
function sendRequest(url, sel) {
  var httpRequest = new XMLHttpRequest();
  httpRequest.onreadystatechange = () => {
    if (httpRequest.readyState === XMLHttpRequest.DONE) {
      if (httpRequest.status === 200) {
        addOptions(url, sel, httpRequest.responseText);
      } else {
        console.log('Error ' + httpRequest.status + '(' + url + ')');
      }
    }
  };
  httpRequest.open('GET', url);
  httpRequest.send();
}
sendRequest(dirBackground, selBackground);
sendRequest(dirImage, selImage);

// ------------ Drop from outside ------------
const screen = document.getElementById('screen');
screen.addEventListener("dragover", (e) => {
  e.preventDefault();
  e.dataTransfer.dropEffect = "copy";
});
screen.addEventListener("drop", (e) => {
  e.preventDefault();
  if (e.dataTransfer.files.length > 0) {
    const files = e.dataTransfer.files;
    for(var i = 0; i < files.length; i++) {
      console.log('File : ' + files[i].name);
    }
    // TBD : file drop...
  } else if (e.dataTransfer.types.indexOf('text/html') >= 0) {
    var data = e.dataTransfer.getData("Text");
    console.log('Html : ' + data);

    var opt = document.createElement('option');
    opt.value = data;
    opt.innerHTML = data.substring(data.lastIndexOf('/')+1);
    selImage.appendChild(opt);
    selectImage(selImage.length - 1);
  }
});

</script>

</body>
</html>
